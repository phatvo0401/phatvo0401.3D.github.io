<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTP | 3D Archive Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --miku: #39c5bb; --violet: #8b5cf6; --glass: rgba(255, 255, 255, 0.03); --border: rgba(57, 197, 187, 0.2); }
        body { font-family: 'Lexend', sans-serif; background-color: #050a09; background-image: radial-gradient(at 0% 0%, rgba(57, 197, 187, 0.1) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.07) 0px, transparent 50%); background-attachment: fixed; color: #e6f7f6; overflow-x: hidden; cursor: none !important; user-select: none; }
        a, button, canvas, .viewport-card, label { cursor: none !important; }
        #cursor-follower { width: 20px; height: 20px; border: 2px solid var(--miku); border-radius: 50%; position: fixed; top: 0; left: 0; pointer-events: none; z-index: 99999; transform: translate(-50%, -50%); background: linear-gradient(45deg, rgba(57, 197, 187, 0.2), rgba(139, 92, 246, 0.2)); display: none; }
        @media (max-width: 768px) { #cursor-follower { display: none !important; } body, a, button, canvas, .viewport-card, label { cursor: auto !important; } }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050a09; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.8s cubic-bezier(0.85, 0, 0.15, 1), opacity 0.5s; }
        #loader.hidden { transform: translateY(-100%); opacity: 0; visibility: hidden; }
        .loader-bar-container { width: 150px; height: 2px; background: rgba(255, 255, 255, 0.05); position: relative; overflow: hidden; border-radius: 2px; }
        #loader-progress { position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: linear-gradient(90deg, var(--miku), var(--violet)); transition: width 0.2s ease; }
        .loader-percentage { font-family: monospace; font-size: 6rem; font-weight: 900; color: var(--miku); opacity: 0.1; position: absolute; bottom: 5%; right: 5%; line-height: 1; }

        .nav-link { transition: all 0.3s ease; padding: 6px 20px; border-radius: 9999px; border: 1px solid rgba(57, 197, 187, 0.6); color: #ffffff; background: rgba(57, 197, 187, 0.15); font-size: 10px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; }
        .nav-link:hover { color: white !important; border-color: var(--violet) !important; box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }

        .gallery-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 24px; }
        @media (min-width: 768px) { .gallery-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .gallery-grid { grid-template-columns: repeat(3, 1fr); } }

        .upload-layout { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media (min-width: 1024px) { .upload-layout { grid-template-columns: 300px 1fr 300px; } }

        .viewport-card { background: var(--glass); border: 1px solid var(--border); border-radius: 24px; padding: 20px; transition: all 0.4s ease; backdrop-filter: blur(12px); }
        .info-card-3d { background: var(--glass); border: 1px solid var(--border); border-radius: 24px; padding: 24px; backdrop-filter: blur(12px); display: flex; flex-direction: column; justify-content: space-between; }
        .viewport-box { position: relative; border-radius: 24px; border: 1px solid var(--border); background: #000; overflow: hidden; min-height: 450px; touch-action: none; }
        
        .btn-outline-miku { background: transparent; border: 1.5px solid var(--miku); color: var(--miku); font-weight: 800; padding: 12px; border-radius: 8px; font-size: 11px; text-align: center; display: block; width: 100%; transition: all 0.4s ease; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; }
        .btn-outline-miku:hover { border-color: var(--violet); color: #ffffff; background: rgba(139, 92, 246, 0.1); box-shadow: 0 0 15px rgba(139, 92, 246, 0.5); }

        .hud-label { font-size: 10px; color: var(--miku); font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }
        .scan-line { position: absolute; width: 100%; height: 1px; background: var(--miku); opacity: 0.1; top: 0; animation: scanMove 3s linear infinite; pointer-events: none; }
        @keyframes scanMove { 0% { top: 0%; } 100% { top: 100%; } }

        /* TRANSFORM TOOLS */
        .transform-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; z-index: 10; opacity: 0; visibility: hidden; transition: 0.3s; }
        .viewport-box:hover .transform-controls { opacity: 1; visibility: visible; }
        .tool-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); color: var(--miku); width: 32px; height: 32px; border-radius: 8px; font-size: 10px; font-weight: 900; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: 0.2s; }
        .tool-btn:hover { background: var(--miku); color: #000; box-shadow: 0 0 15px var(--miku); }
        .tool-btn.reset { border-color: var(--violet); color: var(--violet); }
        .tool-btn.reset:hover { background: var(--violet); color: white; box-shadow: 0 0 15px var(--violet); }

        .three-container { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 16px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .media-content { width: 100%; height: 100%; object-fit: cover; border-radius: 16px; }
        
        #backToTop { position: fixed; bottom: 30px; right: 30px; width: 45px; height: 45px; border-radius: 50%; background: rgba(57, 197, 187, 0.1); border: 1px solid var(--border); color: var(--miku); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(10px); }
        #backToTop.show { opacity: 1; visibility: visible; }
        #backToTop:hover { border-color: var(--violet); color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.4); }

        .section-subtitle { font-size: 1.5rem; font-weight: 900; margin-bottom: 2rem; color: var(--miku); text-transform: uppercase; letter-spacing: -0.025em; }
        .gradient-text { background: linear-gradient(90deg, var(--miku), var(--violet)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body>
    <div id="cursor-follower"></div>
    <div id="loader">
        <div class="flex flex-col items-center">
            <div class="flex items-center text-lg tracking-tighter mb-4"><span class="font-black text-[#39c5bb] mr-1.5 uppercase">VTP</span><span class="font-light text-white opacity-90">3D Archive</span></div>
            <div class="loader-bar-container"><div id="loader-progress"></div></div>
        </div>
        <div id="loader-num" class="loader-percentage">00</div>
    </div>

    <nav class="fixed w-full z-50 py-3 px-4 md:px-10 flex justify-between items-center bg-[#050a09]/70 backdrop-blur-xl border-b border-white/5">
        <div class="flex flex-col flex-shrink-0 mr-6">
            <div class="text-md md:text-lg flex items-center tracking-tighter"><span class="font-black text-[#39c5bb] mr-1.5 uppercase">VTP</span><span class="font-light text-white opacity-90">Design</span></div>
            <div class="flex flex-col space-y-0.5 mt-1">
                <div class="items-center space-x-1.5 hidden md:flex"><div class="relative flex h-1.5 w-1.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#39c5bb] opacity-75"></span><span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-[#39c5bb]"></span></div><span class="text-[8px] font-bold uppercase tracking-widest text-gray-400">Available</span></div>
                <span id="digital-clock" class="text-[8px] font-mono text-gray-500 tracking-wider">00:00:00 AM</span>
            </div>
        </div>
        <a href="https://phatvo0401.github.io/#home" class="nav-link">Back to home</a>
    </nav>

    <header class="pt-56 pb-20 text-center px-4">
        <h1 class="text-5xl md:text-8xl font-black mb-4 uppercase leading-tight tracking-tighter italic">GALLERY <span class="gradient-text pr-2">3D</span></h1>
        <p class="text-white/50 font-medium tracking-[0.5em] uppercase text-[9px] md:text-[11px]">Lưu trữ mô hình dự án cá nhân</p>
    </header>

    <main class="max-w-7xl mx-auto pb-40 px-6">
        <div class="reveal mb-32">
            <h3 class="section-subtitle">TRÌNH CHIẾU</h3>
            <div class="gallery-grid" id="main-grid"></div>
        </div>

        <div class="reveal mt-32">
            <h3 class="section-subtitle">DỰ ÁN CỦA BẠN</h3>
            <div class="upload-layout">
                <div class="info-card-3d">
                    <div><div class="hud-label mb-4">Designer Profile</div><p class="text-xs text-gray-400 leading-relaxed">Phân tích tệp tin STL cá nhân với thông số kỹ thuật thời gian thực.</p></div>
                    <div class="space-y-4">
                        <div class="hud-label">Technical Stats</div>
                        <div class="text-[11px] border-b border-white/5 pb-2 flex justify-between"><span class="text-gray-500">Geometry</span><span id="poly-count" class="text-[#39c5bb]">N/A</span></div>
                        <div class="text-[11px] flex justify-between"><span class="text-gray-500">Axis Sync</span><span class="text-[#39c5bb]">Auto-Vertical</span></div>
                    </div>
                </div>
                <div class="viewport-box" id="upload-viewport-container">
                    <div class="transform-controls" id="transform-menu">
                        <button class="tool-btn" onclick="rotateModel('x')" title="Xoay X">RX</button>
                        <button class="tool-btn" onclick="rotateModel('y')" title="Xoay Y">RY</button>
                        <button class="tool-btn" onclick="rotateModel('z')" title="Xoay Z">RZ</button>
                        <button class="tool-btn reset" onclick="resetRotation()" title="Reset">RST</button>
                    </div>
                    
                    <div class="scan-line"></div>
                    <div class="absolute bottom-6 left-6 pointer-events-none"><div class="text-[9px] text-[#39c5bb] opacity-60 font-mono italic uppercase tracking-widest">LIVE_RENDER_ENGINE: SYNCED</div></div>
                </div>
                <div class="info-card-3d">
                    <div><div class="hud-label mb-4">Project Info</div><p class="text-xs text-gray-100 font-bold uppercase" id="model-name-upload">No File Selected</p><p class="text-[10px] text-gray-500 mt-2 italic leading-relaxed">Tải lên file .STL để kiểm tra cấu trúc mô hình.</p></div>
                    <div class="space-y-4">
                        <label for="stl-input" class="btn-outline-miku">TẢI LÊN FILE .STL</label>
                        <input type="file" id="stl-input" accept=".stl" class="hidden">
                        <div class="text-[9px] text-center text-gray-600 uppercase tracking-widest">Orbit Active: 0° - 40°</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button id="backToTop">↑</button>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // UTILS
        const cursor = document.getElementById('cursor-follower');
        document.addEventListener('mousemove', (e) => { if (window.innerWidth > 768) { cursor.style.display = 'block'; cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px'; } });
        function updateClock() { document.getElementById('digital-clock').innerText = new Date().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' }).toUpperCase(); }
        setInterval(updateClock, 1000); updateClock();

        const getMikuMaterial = () => new THREE.MeshPhongMaterial({ color: 0x39c5bb, specular: 0x222222, shininess: 80 });
        const setupLighting = (scene) => {
            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const sun = new THREE.DirectionalLight(0xffffff, 2.5); sun.position.set(20, 50, 20); scene.add(sun);
            const fill = new THREE.PointLight(0x39c5bb, 1.2); fill.position.set(-20, -20, 20); scene.add(fill);
        };
        const createTechGrid = (group) => {
            const grid = new THREE.PolarGridHelper(35, 24, 12, 64, 0x39c5bb, 0x111111);
            grid.position.y = -22; grid.material.opacity = 0.2; grid.material.transparent = true;
            group.add(grid);
        };

        // GALLERY CONFIGURATION
        const myModels = [
            { id: 'm1', name: 'Hình Dự án', file: 'avt.JPG', type: 'image' }, 
            { id: 'm2', name: 'Con Cụt', file: 'model.stl', type: 'stl' }, 
            { id: 'm3', name: 'Con Gót', file: 'model2.stl', type: 'stl' },
            { id: 'm4', name: 'Dự án video (Demo)', file: 'Demo.mp4', type: 'video' }
        ];

        function initGallery3D(id, path) {
            const container = document.getElementById(id); if(!container) return;
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(40, 1, 0.1, 1000); camera.position.set(0, 55, 80);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientWidth); container.appendChild(renderer.domElement);
            const group = new THREE.Group(); scene.add(group);
            setupLighting(scene); createTechGrid(group);
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.enablePan = false;
            controls.minDistance = 60; controls.maxDistance = 150;
            controls.minPolarAngle = Math.PI/2 - 0.7; controls.maxPolarAngle = Math.PI/2;
            new STLLoader().load(path, (geo) => {
                const mesh = new THREE.Mesh(geo, getMikuMaterial()); geo.center();
                const size = new THREE.Vector3(); new THREE.Box3().setFromObject(mesh).getSize(size);
                const scale = 50 / Math.max(size.x, size.y, size.z); mesh.scale.set(scale, scale, scale);
                mesh.rotation.x = -Math.PI / 2; group.add(mesh);
                const anim = () => { requestAnimationFrame(anim); group.rotation.y += 0.005; controls.update(); renderer.render(scene, camera); }; anim();
            });
        }

        // UPLOAD ENGINE & TRANSFORM LOGIC
        let upScene, upCam, upRen, upControls, upGroup, upMesh;
        const upContainer = document.getElementById('upload-viewport-container');
        
        function initUploadEngine() {
            upScene = new THREE.Scene();
            upCam = new THREE.PerspectiveCamera(40, upContainer.clientWidth / upContainer.clientHeight, 0.1, 1000); upCam.position.set(0, 55, 80);
            upRen = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            upRen.setSize(upContainer.clientWidth, upContainer.clientHeight); upContainer.appendChild(upRen.domElement);
            upGroup = new THREE.Group(); upScene.add(upGroup);
            setupLighting(upScene); createTechGrid(upGroup);
            upControls = new OrbitControls(upCam, upRen.domElement); 
            upControls.enableDamping = true; upControls.enablePan = false;
            upControls.minDistance = 60; upControls.maxDistance = 150;
            upControls.minPolarAngle = Math.PI/2 - 0.7; upControls.maxPolarAngle = Math.PI/2;
            const anim = () => { requestAnimationFrame(anim); upGroup.rotation.y += 0.005; upControls.update(); upRen.render(upScene, upCam); }; anim();
        }
        initUploadEngine();

        // TRANSFORM FUNCTIONS (Đưa vào global để nút bấm gọi được)
        window.rotateModel = (axis) => {
            if(!upMesh) return;
            const step = Math.PI / 2; // 90 độ
            if(axis === 'x') upMesh.rotation.x += step;
            if(axis === 'y') upMesh.rotation.y += step;
            if(axis === 'z') upMesh.rotation.z += step;
        };
        window.resetRotation = () => {
            if(!upMesh) return;
            upMesh.rotation.set(-Math.PI/2, 0, 0); // Về mặc định
        };

        document.getElementById('stl-input').onchange = (e) => {
            const file = e.target.files[0]; if(!file) return;
            document.getElementById('model-name-upload').innerText = file.name.toUpperCase();
            const reader = new FileReader();
            reader.onload = (ev) => {
                const geo = new STLLoader().parse(ev.target.result);
                if(upMesh) upGroup.remove(upMesh);
                upMesh = new THREE.Mesh(geo, getMikuMaterial()); geo.center();
                const size = new THREE.Vector3(); new THREE.Box3().setFromObject(upMesh).getSize(size);
                const scale = 50 / Math.max(size.x, size.y, size.z); upMesh.scale.set(scale, scale, scale);
                upMesh.rotation.x = -Math.PI / 2; upGroup.add(upMesh);
                document.getElementById('poly-count').innerText = (geo.attributes.position.count / 3).toLocaleString() + ' Polys';
            };
            reader.readAsArrayBuffer(file);
        };

        // RENDER GRID
        const gridEl = document.getElementById('main-grid');
        myModels.forEach(m => {
            const card = document.createElement('div'); card.className = 'viewport-card';
            let mediaHTML = m.type === 'stl' ? `<div class="three-container" id="${m.id}"></div>` : 
                           (m.type === 'video' ? `<div class="three-container"><video src="${m.file}" class="media-content" autoplay loop muted playsinline></video></div>` : 
                           `<div class="three-container"><img src="${m.file}" class="media-content"></div>`);

            card.innerHTML = mediaHTML + `<div class="mt-8"><h3 class="font-black text-xl uppercase tracking-tighter text-[#39c5bb]">${m.name}</h3><p class="text-[8px] font-bold text-white/20 uppercase tracking-widest mt-1">VTP ARCHIVE</p></div>`;
            gridEl.appendChild(card); 
            if(m.type === 'stl') initGallery3D(m.id, m.file);
        });

        const btt = document.getElementById('backToTop');
        window.onscroll = () => { if (window.scrollY > 500) btt.classList.add('show'); else btt.classList.remove('show'); };
        btt.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

        let p = 0; const li = setInterval(() => { p += 5; document.getElementById('loader-progress').style.width=p+'%'; document.getElementById('loader-num').innerText=p.toString().padStart(2,'0'); if(p>=100){ clearInterval(li); setTimeout(()=>document.getElementById('loader').classList.add('hidden'),500); } }, 50);
    </script>
</body>
</html>
